# 2026-01-08 — Session log

## Summary

- Added site-wide breadcrumbs (Features/Pricing/Docs/Blogs, and `/podcast-mvp`).
- Improved `/podcast-mvp` TTS UX: skeleton loading, upload text file split into Part1/Part2 (>5000), and history pagination.
- Fixed history audio playback/duration by improving the audio endpoint to support `Range` + correct headers.
- Added Public/Private voices toggle; Private hides provider voices and only shows cloned voices.
- Voice Cloning is kept but gated as “即将上线” (sidebar shows badge; clicking shows “正在上线中” modal).
- Added Token system:
  - `users.tokens` column default `500`
  - Header shows token balance next to GitHub
  - TTS generation consumes tokens (`ceil(chars/4)` by default; configurable)
  - “积分不足” modal with “充值会员” button to Pricing
  - Dev helper endpoint to set current user tokens.

## Key changes (files)

- Tokens
  - DB: `src/lib/db/schema/users.ts` (`tokens` default 500) + migration `drizzle/0002_bored_young_avengers.sql`
  - API: `src/app/api/tokens/route.ts`
  - TTS charge: `src/app/api/tts/generate/route.ts` (atomic decrement + 402 on insufficient)
  - Header display + event broadcast: `src/components/layout/header.tsx`
  - Insufficient tokens modal + step status for Generate: `src/components/PlayButton.tsx`
  - Dev-only set tokens: `src/app/api/dev/set-tokens/route.ts` (GET `?tokens=...`)

- TTS UI/History
  - Generated History pagination (6/page): `src/components/TTSPage.tsx`
  - Audio stream fix: `src/app/api/tts/audio/[id]/route.ts`

- Navigation/UI
  - Breadcrumb component: `src/components/ui/breadcrumb.tsx`
  - Breadcrumbs in pages/templates/blogs: `src/components/pages/page-template.tsx`, `src/components/blogs/*`, `src/components/TTSPage.tsx`
  - Hide footer on `/podcast-mvp`: `src/components/layout/footer-wrapper.tsx`

## “开工” checklist for model usage + switching (next time)

- Check **current provider + model**
  - Visit `GET /api/tts/meta` (PlayButton logs meta in console too).
  - Look at `provider`, and for OpenAI look at `model`.
- Check **cost tier / voice tier**
  - `GET /api/tts/meta` includes `billingTier` for Google voices (standard/wavenet/neural2/studio/chirp3-hd).
- Switch **provider**
  - Update `.env.local` `TTS_PROVIDER` to `google` / `openai` / `elevenlabs`, then restart `pnpm dev`.
  - OpenAI: ensure `OPENAI_API_KEY` + optional `OPENAI_MODEL_TTS`.
  - Google: ensure `GOOGLE_APPLICATION_CREDENTIALS` points to service account JSON.
  - ElevenLabs: ensure `ELEVENLABS_API_KEY` (cloning is still gated “coming soon”).
- Check **our internal token usage**
  - Header shows balance; API `GET /api/tokens`.
  - Token cost rule: `ceil(chars/4)` (env `TTS_TOKEN_CHARS_PER_TOKEN`).
  - Test insufficient flow by setting small balance: `GET /api/dev/set-tokens?tokens=3` (dev only).


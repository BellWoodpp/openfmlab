# 2026-01-07_1810

## Context

- Issue: OpenAI API quota exhausted; migrated TTS to Google Cloud TTS.
- Goal: Only use TTS, be cost-aware, and allow MP3 download after generation.

## Changes (high level)

- Added Google Cloud TTS provider plumbing (service account via `GOOGLE_APPLICATION_CREDENTIALS`).
- Exposed voice/language/meta endpoints for transparency and debugging.
- Sorted voices cheapest-first so default user choices are cheaper unless manually changed.
- Implemented “generate once → reuse” by storing `latestAudioBlobUrl` and using it for Play/Download.

## Fix: `Cannot access 'voice_0' before initialization`

- Symptom: Runtime TDZ error in browser bundle.
- Root cause: `PlayButton.tsx` re-declared `voice` inside the `try {}` block (shadowing an earlier `voice` used above), which Turbopack emitted as `voice_0` and triggered TDZ at runtime.
- Fix: Removed the Play-button “auto-download MP3” block that re-declared `voice`. Download remains available via the `Download` button.

## Verification

- `pnpm exec next build` (Next.js 16.1.1 / Turbopack): ✅ success

## Notes

- Meta logging: browser console can show `[TTS meta] { provider, format, languageCode, voiceName, billingTier, tone, ... }` via `/api/tts/meta`.
- Speaking rate: Google TTS `speakingRate` is not guaranteed to feel linear; playback-rate is more “true 2x/3x/4x” because it doesn’t re-synthesize.

## Next

- If you want automatic “开工/收工” behavior in future chats: read/write files under `openfmvideo/.codex-progress/`.
- Optional: continue UI polish requests based on screenshots.
